//@version=6
strategy('RSI_L_S_BEP_Optimizer_Report', overlay = true, default_qty_type = strategy.percent_of_equity, default_qty_value = 100, initial_capital = 100)

// ===================== RSI AyarlarÄ± =====================
src = input(close, 'RSI Source')
rsiLen = input(9, 'RSI Length')
rsiOver = input(68, 'RSI Overbought')
rsiUnder = input(31, 'RSI Oversold')
rsiVal = ta.rsi(src, rsiLen)

// ===================== Leverage =====================
leverage = input.int(1, 'Leverage (X)', minval = 1)
qty = math.round(strategy.equity * leverage / close)

// ===================== Trail Stop Optimizasyon Parametreleri =====================
trail_start = input.float(0.5, 'Trail Start %', step = 0.1) * 0.01
trail_end = input.float(2.0, 'Trail End %', step = 0.1) * 0.01
trail_step = input.float(0.1, 'Trail Step %', step = 0.01) * 0.01

offset_start = input.float(0.02, 'Offset Start %', step = 0.01) * 0.01
offset_end = input.float(0.1, 'Offset End %', step = 0.01) * 0.01
offset_step = input.float(0.01, 'Offset Step %', step = 0.01) * 0.01

// ===================== Ek Optimizasyon SeÃ§enekleri =====================
enableRSIOptimization = input.bool(false, 'Enable RSI Optimization')
rsiLenStart = input.int(5, 'RSI Length Start', minval=3, maxval=50)
rsiLenEnd = input.int(20, 'RSI Length End', minval=3, maxval=50)
rsiLenStep = input.int(1, 'RSI Length Step', minval=1)

enableThresholdOptimization = input.bool(false, 'Enable RSI Threshold Optimization')
rsiOverStart = input.int(60, 'RSI Overbought Start', minval=50, maxval=90)
rsiOverEnd = input.int(80, 'RSI Overbought End', minval=50, maxval=90)
rsiOverStep = input.int(2, 'RSI Overbought Step', minval=1)

rsiUnderStart = input.int(20, 'RSI Oversold Start', minval=10, maxval=50)
rsiUnderEnd = input.int(40, 'RSI Oversold End', minval=10, maxval=50)
rsiUnderStep = input.int(2, 'RSI Oversold Step', minval=1)

// ===================== GiriÅŸ KoÅŸullarÄ± =====================
longEntry = ta.crossover(rsiVal, rsiOver)
shortEntry = ta.crossunder(rsiVal, rsiUnder)

// ===================== DetaylÄ± Optimizasyon DeÄŸiÅŸkenleri =====================
var float bestProfit = na
var float bestTrail = na
var float bestOffset = na
var int bestTrades = na
var float bestWinRate = na
var float bestMaxDD = na
var float bestSharpe = na
var int bestLongTrades = na
var int bestShortTrades = na
var float bestAvgWin = na
var float bestAvgLoss = na
var int bestRSILen = na
var int bestRSIOver = na
var int bestRSIUnder = na

// ===================== GeliÅŸmiÅŸ Optimizasyon DÃ¶ngÃ¼sÃ¼ =====================
// RSI Length optimizasyonu
rsiLenRange = enableRSIOptimization ? range(rsiLenStart, rsiLenEnd, rsiLenStep) : array.from(rsiLen)
rsiOverRange = enableThresholdOptimization ? range(rsiOverStart, rsiOverEnd, rsiOverStep) : array.from(rsiOver)
rsiUnderRange = enableThresholdOptimization ? range(rsiUnderStart, rsiUnderEnd, rsiUnderStep) : array.from(rsiUnder)

// Ana optimizasyon dÃ¶ngÃ¼sÃ¼
for rsiLenOpt in rsiLenRange
    for rsiOverOpt in rsiOverRange
        for rsiUnderOpt in rsiUnderRange
            // Optimize edilmiÅŸ RSI deÄŸerleri
            rsiValOpt = ta.rsi(src, rsiLenOpt)
            longEntryOpt = ta.crossover(rsiValOpt, rsiOverOpt)
            shortEntryOpt = ta.crossunder(rsiValOpt, rsiUnderOpt)
            
            for tp = trail_start to trail_end by trail_step
                for off = offset_start to offset_end by offset_step
                    // Optimize edilmiÅŸ giriÅŸ sinyalleri
                    if longEntryOpt
                        strategy.entry('LONG', strategy.long, qty = qty)
                    if shortEntryOpt
                        strategy.entry('SHORT', strategy.short, qty = qty)

                    // Pozisyon yÃ¶netimi
                    if strategy.position_size > 0
                        trailPts = strategy.position_avg_price * tp / syminfo.mintick
                        offsetPts = strategy.position_avg_price * off / syminfo.mintick
                        strategy.exit(id = 'L-Trail', trail_points = trailPts, trail_offset = offsetPts)

                    if strategy.position_size < 0
                        trailPts = strategy.position_avg_price * tp / syminfo.mintick
                        offsetPts = strategy.position_avg_price * off / syminfo.mintick
                        strategy.exit(id = 'S-Trail', trail_points = trailPts, trail_offset = offsetPts)

                    // ===================== DetaylÄ± Performans Analizi =====================
                    currentProfit = strategy.netprofit
                    currentTrades = strategy.closedtrades
                    currentWinRate = strategy.wintrades / math.max(currentTrades, 1) * 100
                    currentMaxDD = strategy.max_drawdown
                    currentSharpe = strategy.sharpe_ratio
                    currentLongTrades = strategy.long_closedtrades
                    currentShortTrades = strategy.short_closedtrades
                    currentAvgWin = strategy.avg_win_trade
                    currentAvgLoss = strategy.avg_loss_trade
                    
                    // En iyi performansÄ± kontrol et (Net Profit'e gÃ¶re)
                    if na(bestProfit) or currentProfit > bestProfit
                        bestProfit := currentProfit
                        bestTrail := tp
                        bestOffset := off
                        bestTrades := currentTrades
                        bestWinRate := currentWinRate
                        bestMaxDD := currentMaxDD
                        bestSharpe := currentSharpe
                        bestLongTrades := currentLongTrades
                        bestShortTrades := currentShortTrades
                        bestAvgWin := currentAvgWin
                        bestAvgLoss := currentAvgLoss
                        bestRSILen := rsiLenOpt
                        bestRSIOver := rsiOverOpt
                        bestRSIUnder := rsiUnderOpt

// ===================== DetaylÄ± SonuÃ§ Raporu =====================
if barstate.islast
    // Ana optimizasyon sonuÃ§larÄ±
    mainLabel = 'ğŸ¯ ADVANCED OPTIMIZATION RESULTS ğŸ¯\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸ“Š Best Parameters:\nâ€¢ Trail Stop: ' + str.tostring(bestTrail * 100, '#.##') + '%\nâ€¢ Offset: ' + str.tostring(bestOffset * 100, '#.##') + '%\nâ€¢ RSI Length: ' + str.tostring(bestRSILen) + '\nâ€¢ RSI Overbought: ' + str.tostring(bestRSIOver) + '\nâ€¢ RSI Oversold: ' + str.tostring(bestRSIUnder) + '\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸ’° Performance:\nâ€¢ Net Profit: $' + str.tostring(bestProfit, '#.##') + '\nâ€¢ Total Trades: ' + str.tostring(bestTrades) + '\nâ€¢ Win Rate: ' + str.tostring(bestWinRate, '#.##') + '%\nâ€¢ Max Drawdown: ' + str.tostring(bestMaxDD, '#.##') + '%\nâ€¢ Sharpe Ratio: ' + str.tostring(bestSharpe, '#.##') + '\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nğŸ“ˆ Trade Breakdown:\nâ€¢ Long Trades: ' + str.tostring(bestLongTrades) + '\nâ€¢ Short Trades: ' + str.tostring(bestShortTrades) + '\nâ€¢ Avg Win: $' + str.tostring(bestAvgWin, '#.##') + '\nâ€¢ Avg Loss: $' + str.tostring(bestAvgLoss, '#.##')
    
    label.new(bar_index, high, mainLabel, 
              style = label.style_label_down, 
              color = color.yellow, 
              textcolor = color.black,
              size = size.normal)
    
    // Performans uyarÄ±larÄ±
    if bestWinRate < 50
        alertLabel = 'âš ï¸ LOW WIN RATE WARNING âš ï¸\nWin Rate: ' + str.tostring(bestWinRate, '#.##') + '%\nConsider adjusting parameters!'
        label.new(bar_index, high * 0.95, alertLabel, 
                  style = label.style_label_down, 
                  color = color.red, 
                  textcolor = color.white,
                  size = size.small)
    
    if bestMaxDD > 20
        ddLabel = 'ğŸš¨ HIGH DRAWDOWN WARNING ğŸš¨\nMax DD: ' + str.tostring(bestMaxDD, '#.##') + '%\nRisk too high!'
        label.new(bar_index, high * 0.90, ddLabel, 
                  style = label.style_label_down, 
                  color = color.orange, 
                  textcolor = color.white,
                  size = size.small)
